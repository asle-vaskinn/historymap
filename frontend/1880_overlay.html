<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Trondheim 1880 - Buildings Then vs Now</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        .legend h3 { margin: 0 0 10px 0; font-size: 16px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; margin-right: 8px; border-radius: 3px; }

        .info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        .info h2 { margin: 0 0 10px 0; }
        .info p { margin: 5px 0; font-size: 14px; color: #666; }

        .toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toggle label { cursor: pointer; font-size: 14px; }

        .stats {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 13px;
        }
        .stats h4 { margin: 0 0 8px 0; }
        .stat-row { display: flex; justify-content: space-between; margin: 3px 0; }
        .stat-value { font-weight: bold; margin-left: 15px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="info">
        <h2>Trondheim 1880</h2>
        <p>Current buildings overlaid on the historical map, showing which existed in 1880.</p>
        <p>Data: SEFRAK registry + ML extraction from 1880 Kartverket map</p>
    </div>

    <div class="toggle">
        <label>
            <input type="checkbox" id="show-historical" checked> Show 1880 map
        </label>
    </div>

    <div class="legend">
        <h3>Building Status in 1880</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #22c55e;"></div>
            <span>Existed in 1880</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #6b7280;"></div>
            <span>Built after 1880</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #d1d5db;"></div>
            <span>Unknown date</span>
        </div>
    </div>

    <div class="stats">
        <h4>Statistics</h4>
        <div class="stat-row"><span>Existed in 1880:</span><span class="stat-value" id="stat-existed">-</span></div>
        <div class="stat-row"><span>Built after 1880:</span><span class="stat-value" id="stat-after">-</span></div>
        <div class="stat-row"><span>Unknown:</span><span class="stat-value" id="stat-unknown">-</span></div>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap'
                    }
                },
                layers: [{
                    id: 'osm-base',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            center: [10.40, 63.43],
            zoom: 14
        });

        map.on('load', () => {
            // Add 1880 map as overlay (if georeferenced version exists)
            // For now, we'll use a placeholder - you'd replace with actual georeferenced tiles

            // Add buildings GeoJSON
            fetch('../data/export/buildings_1880_overlay.geojson')
                .then(r => r.json())
                .then(data => {
                    // Update stats
                    const stats = data.metadata.categories;
                    document.getElementById('stat-existed').textContent = stats.existed_1880.toLocaleString();
                    document.getElementById('stat-after').textContent = stats.built_after_1880.toLocaleString();
                    document.getElementById('stat-unknown').textContent = stats.unknown.toLocaleString();

                    map.addSource('buildings', {
                        type: 'geojson',
                        data: data
                    });

                    // Existed in 1880 - Green
                    map.addLayer({
                        id: 'buildings-existed',
                        type: 'fill',
                        source: 'buildings',
                        filter: ['==', ['get', 'status_1880'], 'existed_1880'],
                        paint: {
                            'fill-color': '#22c55e',
                            'fill-opacity': 0.7,
                            'fill-outline-color': '#15803d'
                        }
                    });

                    // Built after 1880 - Gray
                    map.addLayer({
                        id: 'buildings-after',
                        type: 'fill',
                        source: 'buildings',
                        filter: ['==', ['get', 'status_1880'], 'built_after_1880'],
                        paint: {
                            'fill-color': '#6b7280',
                            'fill-opacity': 0.5,
                            'fill-outline-color': '#374151'
                        }
                    });

                    // Unknown - Light gray
                    map.addLayer({
                        id: 'buildings-unknown',
                        type: 'fill',
                        source: 'buildings',
                        filter: ['==', ['get', 'status_1880'], 'unknown'],
                        paint: {
                            'fill-color': '#d1d5db',
                            'fill-opacity': 0.3,
                            'fill-outline-color': '#9ca3af'
                        }
                    });

                    // Popup on click
                    map.on('click', ['buildings-existed', 'buildings-after', 'buildings-unknown'], (e) => {
                        const props = e.features[0].properties;
                        const html = `
                            <strong>${props.name || 'Unnamed building'}</strong><br>
                            Status 1880: <b>${props.status_1880.replace('_', ' ')}</b><br>
                            ${props.start_year ? `Built: ${props.start_year}<br>` : ''}
                            ${props.method ? `Method: ${props.method}<br>` : ''}
                            ${props.confidence ? `Confidence: ${(props.confidence * 100).toFixed(0)}%` : ''}
                        `;
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(html)
                            .addTo(map);
                    });

                    // Change cursor on hover
                    map.on('mouseenter', ['buildings-existed', 'buildings-after', 'buildings-unknown'], () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', ['buildings-existed', 'buildings-after', 'buildings-unknown'], () => {
                        map.getCanvas().style.cursor = '';
                    });
                });
        });

        // Toggle historical map layer
        document.getElementById('show-historical').addEventListener('change', (e) => {
            // Would toggle historical map overlay here
            console.log('Historical map toggle:', e.target.checked);
        });
    </script>
</body>
</html>
