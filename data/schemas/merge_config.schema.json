{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://historymap.example.com/schemas/merge_config.schema.json",
  "title": "Merge Configuration Schema",
  "description": "Schema for validating merge configuration files that control how multiple building data sources are combined",
  "type": "object",
  "required": ["version", "sources", "matching", "conflict_resolution", "output"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this JSON Schema file"
    },
    "version": {
      "type": "string",
      "description": "Configuration version",
      "pattern": "^\\d+\\.\\d+$"
    },
    "created": {
      "type": "string",
      "description": "Date when configuration was created",
      "format": "date"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of this configuration"
    },
    "sources": {
      "type": "object",
      "description": "Data sources to be merged",
      "minProperties": 1,
      "patternProperties": {
        "^[a-zA-Z0-9_]+$": {
          "type": "object",
          "required": ["enabled", "path", "priority", "trust_dates", "evidence_strength"],
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether this source should be included in the merge"
            },
            "path": {
              "type": "string",
              "description": "Relative or absolute path to the normalized GeoJSON file"
            },
            "priority": {
              "type": "number",
              "description": "Priority for conflict resolution (lower number = higher priority)",
              "minimum": 1
            },
            "trust_dates": {
              "description": "Whether to trust dates from this source",
              "oneOf": [
                {
                  "type": "boolean"
                },
                {
                  "type": "string",
                  "enum": ["if_explicit"]
                }
              ]
            },
            "date_represents": {
              "type": "string",
              "description": "What the reference date represents for ML-detected sources",
              "enum": ["exact", "not_later_than", "not_earlier_than", "approximate"]
            },
            "reference_year": {
              "type": "integer",
              "description": "Reference year for ML-detected sources from historical maps",
              "minimum": 1000,
              "maximum": 2100
            },
            "evidence_strength": {
              "type": "string",
              "description": "Base evidence strength for this source",
              "enum": ["low", "medium", "high"]
            },
            "evidence_strength_with_date": {
              "type": "string",
              "description": "Evidence strength when explicit date is present",
              "enum": ["low", "medium", "high"]
            },
            "notes": {
              "type": "string",
              "description": "Additional notes about this source"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "matching": {
      "type": "object",
      "description": "Configuration for matching buildings across sources",
      "required": ["method", "overlap_threshold", "centroid_max_distance_m"],
      "properties": {
        "method": {
          "type": "string",
          "description": "Method used for matching buildings",
          "enum": ["spatial_overlap", "centroid_distance", "combined"]
        },
        "overlap_threshold": {
          "type": "number",
          "description": "Minimum overlap ratio to consider buildings as matching",
          "minimum": 0,
          "maximum": 1
        },
        "centroid_max_distance_m": {
          "type": "number",
          "description": "Maximum distance in meters between centroids for matching",
          "minimum": 0
        },
        "prefer_larger_geometry": {
          "type": "boolean",
          "description": "Whether to prefer larger geometries when merging"
        }
      },
      "additionalProperties": false
    },
    "conflict_resolution": {
      "type": "object",
      "description": "Rules for resolving conflicts between sources",
      "required": ["date_conflict", "geometry_conflict", "merge_evidence", "preserve_all_source_ids"],
      "properties": {
        "date_conflict": {
          "type": "string",
          "description": "How to resolve conflicting dates",
          "enum": ["prefer_higher_priority", "prefer_older", "prefer_newer", "keep_all"]
        },
        "geometry_conflict": {
          "type": "string",
          "description": "How to resolve conflicting geometries",
          "enum": ["prefer_higher_priority", "prefer_larger", "prefer_smaller", "union", "intersection"]
        },
        "merge_evidence": {
          "type": "boolean",
          "description": "Whether to merge evidence from multiple sources"
        },
        "preserve_all_source_ids": {
          "type": "boolean",
          "description": "Whether to preserve all source IDs when merging"
        }
      },
      "additionalProperties": false
    },
    "replacement_detection": {
      "type": "object",
      "description": "Configuration for detecting building replacements over time",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether replacement detection is enabled"
        },
        "overlap_threshold": {
          "type": "number",
          "description": "Overlap threshold for detecting replacements",
          "minimum": 0,
          "maximum": 1
        },
        "centroid_max_distance_m": {
          "type": "number",
          "description": "Maximum centroid distance for detecting replacements",
          "minimum": 0
        },
        "rules": {
          "type": "array",
          "description": "Rules for different eras defining when old buildings should be hidden",
          "items": {
            "type": "object",
            "required": ["era", "old_building_hidden_when"],
            "properties": {
              "era": {
                "type": "string",
                "description": "Time period identifier",
                "pattern": "^[a-zA-Z0-9_]+$"
              },
              "old_building_hidden_when": {
                "type": "string",
                "description": "Condition for hiding old building when replacement is detected"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "output": {
      "type": "object",
      "description": "Output configuration",
      "required": ["include_source_breakdown", "preserve_all_sources", "output_file"],
      "properties": {
        "include_source_breakdown": {
          "type": "boolean",
          "description": "Whether to include source breakdown in output"
        },
        "preserve_all_sources": {
          "type": "boolean",
          "description": "Whether to preserve all source information in merged output"
        },
        "output_file": {
          "type": "string",
          "description": "Name of the output file"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
